<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EOTS — Unified Ops Console (FAA • NTSB • SATA • Maritime)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  /* ===== DARK CAD-STYLE PALETTE ===== */
  :root{
    --bg:#0b0f14;        /* page */
    --ink:#e7edf6;       /* primary text */
    --muted:#8ea2b4;     /* secondary text */
    --panel:#141a22;     /* cards */
    --grid:#243041;      /* borders */
    --panel2:#0f1621;    /* headers / bars */

    --blue:#3b82f6; --cyan:#06b6d4; --red:#ef4444; --amber:#f59e0b; --green:#22c55e; --teal:#0ea5a5; --purple:#7c3aed;

    --chip-ink:#c9d7e6; --chip-bg:#1b2430; --chip-brd:#2a3646;

    --shadow:0 1px 0 rgba(255,255,255,.02) inset, 0 8px 24px rgba(0,0,0,.25);
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Arial,sans-serif}

  /* ===== Header ===== */
  .header{
    display:flex;justify-content:space-between;align-items:center;gap:14px;flex-wrap:wrap;
    padding:14px 18px;color:#eaf2ff;
    background:linear-gradient(90deg,#0e1621,#1b293b);
    border-bottom:1px solid var(--grid)
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logoDot{width:10px;height:10px;border-radius:50%;background:#60a5fa;box-shadow:0 0 0 4px rgba(96,165,250,.18)}
  .brand .title{font-size:18px;font-weight:700;letter-spacing:.3px}
  .brand .subtitle{font-size:12px;opacity:.85}
  .badge{background:#0f1926;border:1px solid #233041;color:#cfe1ff;border-radius:999px;padding:6px 10px;font-size:12px}
  .login{font-size:12px;color:#fff;opacity:.95;display:flex;gap:8px;align-items:center}
  .login input{width:160px;border-radius:10px;padding:6px 10px;border:1px solid #2a3646;background:#101720;color:#dbe7f6}

  /* ===== Watermark (small lion) ===== */
  .wm{pointer-events:none;position:fixed;right:12px;bottom:10px;z-index:0;opacity:.06}
  .wm img{max-width:120px;max-height:120px;filter:grayscale(1)}

  /* ===== Nav ===== */
  .topnav,.subnav{padding:12px 16px}
  .seg,.subtab{
    background:var(--panel); color:var(--ink); border:1px solid var(--grid); border-radius:10px; padding:8px 12px; cursor:pointer
  }
  .seg.active,.subtab.active{border-color:#4a6aa3; box-shadow:0 0 0 1px #3a5c8c inset, 0 4px 12px rgba(0,0,0,.25)}

  /* ===== Layout ===== */
  .wrap{max-width:1620px;margin:0 auto;padding:0 16px 28px;position:relative;z-index:1}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--grid);border-radius:12px;padding:14px;display:flex;flex-direction:column;box-shadow:var(--shadow)}
  .sectionTitle{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .sectionTitle h3{margin:0;font-size:16px;font-weight:700}

  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
  .tab{border:1px solid var(--grid);background:#0f1620;color:#cfe1ff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .tab:hover{border-color:#4a6aa3}
  .tab.active{background:#122136;border-color:#4a6aa3;box-shadow:0 0 0 1px #3a5c8c inset}
  .panel{display:none}.panel.active{display:block}

  /* Forms */
  label{display:block;margin:6px 0 4px;font-size:12px;color:#cfe1ff}
  .req::after{content:" *";color:#f97316;font-weight:700}
  input,select,textarea{
    width:100%;padding:10px 12px;border:1px solid var(--grid);border-radius:10px;background:#0e151e;color:#e7edf6;font-family:inherit
  }
  select:focus,input:focus,textarea:focus{outline:none;box-shadow:0 0 0 2px #375e97 inset;border-color:#4a6aa3}
  .row{display:flex;gap:18px;flex-wrap:wrap;margin-bottom:10px}
  .row>div{flex:1 1 300px;min-width:260px}
  .btn{border:1px solid #2a3646;border-radius:10px;padding:10px 14px;background:#152030;color:#d7e7ff;font-weight:600;cursor:pointer}
  .btn:hover{border-color:#4a6aa3;background:#19263a}
  .btn.ok{background:#153224;border-color:#204d34}
  .btn.warn{background:#3a240e;border-color:#5a3b12}
  .btn.alt{background:#1b2633;border-color:#2d3e55}
  .muted{color:var(--muted);font-size:12px}

  /* Outputs — one per tab, scrollable */
  .outwrap{display:grid;grid-template-columns:1fr;gap:8px;margin-top:6px;max-height:230px;overflow:auto}
  .gme{background:#0b1220;color:#d7e7ff;border:1px solid #233041;border-radius:10px;padding:10px;white-space:pre-wrap;font-family:Consolas,Menlo,monospace}
  .plain{background:#0b0f1a;color:#cfe1ff;border:1px solid #233041;border-radius:10px;padding:10px;white-space:pre-wrap;font-family:Consolas,Menlo,monospace}

  /* Callsign chips under input */
  .chipsbar{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 0}
  .chip{border:1px solid var(--chip-brd);background:var(--chip-bg);color:var(--chip-ink);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  .chip:hover{border-color:#4a6aa3}

  /* ===== Hazard Map ===== */
  .hazLayout{display:grid;grid-template-columns:minmax(760px,1fr) 380px;gap:16px;align-items:start}
  .mapWrap{position:relative;border:1px solid var(--grid);border-radius:12px;overflow:hidden;background:#0f1722}
  #baseImg{display:block;width:100%;height:1450px;object-fit:cover;filter:contrast(1.05) brightness(.85)}
  #hazSVG{position:absolute;inset:0;width:100%;height:1450px}
  .legend,.catPanel{
    position:absolute;background:rgba(15,23,34,.92);border:1px solid #223044;color:#cfe1ff;border-radius:10px;padding:8px 10px;font-size:12px;line-height:1.3
  }
  .legend{top:10px;right:10px}
  .legend h4{margin:2px 0 6px 0;font-size:12px}
  .legend .item{display:flex;align-items:center;gap:8px;margin:4px 0}
  .legend .sw{width:12px;height:12px;border-radius:50%}
  .catPanel{left:10px;top:10px;max-width:260px}
  .catPanel label{display:flex;align-items:center;gap:8px;margin:4px 0}
  .catSw{width:12px;height:12px;border-radius:50%}
  .hazList{background:var(--panel);border:1px solid var(--grid);border-radius:12px;padding:12px;max-height:1450px;overflow:auto}
  .hazList.compact .hazItem{padding:4px 6px;font-size:12px}
  .hazTools{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .hazItem{padding:8px;border-radius:8px;cursor:pointer}
  .hazItem:hover{background:#111a26}
  .dimmed{opacity:.25}
  .highlight{filter:drop-shadow(0 0 10px rgba(96,165,250,.6))}
  .pulse{animation:pulse 1.2s ease 1}
  @keyframes pulse{0%{filter:drop-shadow(0 0 0 rgba(96,165,250,0))}30%{filter:drop-shadow(0 0 14px rgba(96,165,250,.75))}100%{filter:drop-shadow(0 0 0 rgba(96,165,250,0))}}

  /* Agency pages */
  .agencyPage{display:none}.agencyPage.active{display:block}
</style>
</head>
<body>

<!-- ===== Header ===== -->
<div class="header" id="header">
  <div class="brand">
    <div class="logoDot"></div>
    <div>
      <div class="title">Enemy of the State Roleplay</div>
      <div class="subtitle">Unified Ops Console — FAA • NTSB • SATA • Maritime</div>
    </div>
  </div>
  <div class="login">
    <span>Logged in:</span>
    <input id="loginName" value="McGowan" />
    <input id="loginCode" value="00004" />
    <span class="badge" id="loginBadge">McGowan — Controller</span>
  </div>
</div>

<!-- Watermark (small lion) -->
<div class="wm"><img src="eots_log_sticker_transparent_working_copy_512.png" alt="EOTS watermark"></div>

<!-- ===== Agency selector ===== -->
<div class="topnav">
  <div class="seg active" data-agency="faa">FAA</div>
  <div class="seg" data-agency="ntsb">NTSB</div>
  <div class="seg" data-agency="sata">SATA</div>
  <div class="seg" data-agency="mar">Maritime</div>
</div>

<!-- ===== Sub-tabs ===== -->
<div class="subnav">
  <div class="subtab active" data-sub="console">ATC Console</div>
  <div class="subtab" data-sub="refs">References</div>
  <div class="subtab" data-sub="pilot">Pilot Tools</div>
</div>

<div class="wrap">
  <!-- ===================== FAA PAGE ===================== -->
  <div id="page_faa" class="agencyPage active">
    <div id="sub_console" class="grid">
      <div class="card">
        <div class="sectionTitle">
          <h3>ATC Console</h3>
          <div class="row" style="gap:10px;align-items:center;margin:0">
            <label style="display:flex;align-items:center;gap:6px;margin:0">
              <input type="checkbox" id="civilCS"> Treat callsign as civilian (don’t spell NATO)
            </label>
            <button class="btn alt" id="clearATC">Clear Tab Outputs</button>
          </div>
        </div>

        <!-- Inner tabs -->
        <div class="tabs" id="atcTabs">
          <button class="tab active" data-tab="atis">ATIS</button>
          <button class="tab" data-tab="clr">Clearance</button>
          <button class="tab" data-tab="gnd">Ground & Taxi</button>
          <button class="tab" data-tab="twr">Tower</button>
          <button class="tab" data-tab="dap">Departure / Approach</button>
          <button class="tab" data-tab="ctr">Center</button>
          <button class="tab" data-tab="emg">Emergencies</button>
          <button class="tab" data-tab="ads">Ads Builder</button>
          <button class="tab" data-tab="haz">Hazard Map</button>
        </div>

        <!-- ================= ATIS ================= -->
        <div id="panel_atis" class="panel active">
          <div class="row">
            <div>
              <label class="req">Time of Day</label>
              <select id="aTod">
                <option value="">(select)</option>
                <option>Morning</option><option>Midday</option><option>Evening</option><option>Night</option>
              </select>
            </div>
            <div>
              <label class="req">Weather</label>
              <select id="aWx">
                <option value="">(select)</option>
                <option value="CLEAR">Clear</option><option value="OVERCAST">Overcast</option>
                <option value="RAIN">Rain</option><option value="STORM">Thunderstorm</option>
                <option value="SNOW">Snow</option><option value="FOG">Fog</option>
                <option value="WINDY">Windy</option>
              </select>
            </div>
            <div>
              <label class="req">Wind</label>
              <select id="aWind">
                <option value="">(select)</option>
                <option value="CALM">Calm</option><option value="LIGHT">Light</option>
                <option value="BREEZY">Breezy</option><option value="WINDY">Windy</option>
                <option value="CROSS">Crosswind</option>
              </select>
            </div>
            <div>
              <label>Temperature (feel)</label>
              <select id="aTempFeel">
                <option>Cool</option><option>Mild</option><option>Warm</option><option>Hot</option><option>Cold</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div style="flex:0 0 210px">
              <label class="req">ATIS Letter</label>
              <input id="aLetter" value="alpha" disabled>
            </div>
            <div style="flex:0 0 220px;align-self:flex-end">
              <button class="btn alt" id="resetATIS">Reset ATIS Letter</button>
            </div>
            <div style="flex:1 1 420px" class="card">
              <label>Ops Summary</label>
              <div class="row" style="align-items:flex-end">
                <div style="flex:1 1 220px"><label><input type="checkbox" id="apAll" checked> All Airports Operational</label></div>
                <div style="flex:1 1 220px"><label><input type="checkbox" id="aNoise"> Noise Abatement in Effect</label></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div><label>Ops Mode (Global)</label>
              <select id="aOpsMode"><option>Normal</option><option>Reverse</option></select>
            </div>
          </div>

          <div class="row">
            <button class="btn ok" id="genATIS">Generate ATIS — copy</button>
          </div>

          <div class="outwrap">
            <div class="gme" id="atisOut"></div>
            <div class="plain" id="atisPlain"></div>
          </div>
        </div>

        <!-- ================= CLEARANCE ================= -->
        <div id="panel_clr" class="panel">
          <div class="row">
            <div>
              <label class="req">Callsign</label>
              <input id="clrCall" placeholder="N123AB / AIR-1">
              <div class="chipsbar" id="chipsCLR"></div>
            </div>
            <div>
              <label class="req">Type</label>
              <select id="clrType"><option>IFR</option><option>VFR</option><option>Special Ops</option></select>
            </div>
            <div id="specDeptsWrap" style="display:none">
              <label class="req">Departments (multi)</label>
              <select id="specDepts" multiple size="6">
                <option>LSPD</option><option>BCSO</option><option>SASP</option><option>SAFR</option>
                <option>USCG</option><option>SABP</option><option>FIB</option><option>DHS</option><option>LSSD</option><option>LA</option>
              </select>
            </div>
          </div>

          <div id="IFRRow" class="row">
            <div><label class="req">Route (from → to)</label>
              <select id="clrRoute">
                <option>LSIA → SNDY</option><option>LSIA → PBAY</option><option>LSIA → GPSD</option><option>LSIA → RXWD</option>
                <option>SNDY → LSIA</option><option>SNDY → PBAY</option><option>SNDY → GPSD</option><option>SNDY → RXWD</option>
                <option>GPSD → LSIA</option><option>GPSD → PBAY</option><option>GPSD → RXWD</option>
                <option>PBAY → LSIA</option><option>PBAY → GPSD</option><option>PBAY → RXWD</option>
                <option>RXWD → LSIA</option><option>RXWD → GPSD</option><option>RXWD → SNDY</option><option>RXWD → PBAY</option>
              </select>
            </div>
            <div><label>Auto SID</label><input id="clrSid" placeholder="auto" disabled></div>
          </div>

          <div id="VFRRow" class="row" style="display:none">
            <div><label class="req">Departure Airport</label><select id="VFRDep"><option>LSIA</option><option>SNDY</option><option>GPSD</option><option>PBAY</option><option>RXWD</option></select></div>
            <div><label class="req">Direction</label><select id="VFRDir"><option>north</option><option>east</option><option>south</option><option>west</option></select></div>
            <div><label>Nearest Postal (optional)</label><input id="VFRPostal" placeholder="e.g., 3037"></div>
          </div>

          <div id="specRow" class="row" style="display:none">
            <div><label class="req">Departure Airport</label><select id="specDep"><option>LSIA</option><option>SNDY</option><option>GPSD</option><option>PBAY</option><option>RXWD</option></select></div>
            <div>
              <label class="req">Authorized Areas (multi)</label>
              <select id="specAreas" multiple size="8">
                <option>Los Santos (city)</option><option>Sandy Shores</option><option>Grapeseed</option><option>Paleto Bay</option>
                <option>Harmony / Route 68</option><option>Senora Freeway</option><option>Palomino Freeway</option><option>Zancudo Area</option>
              </select>
              <div class="muted">Area-specific hazards will be composed automatically.</div>
            </div>
            <div><label class="req">Ops Direction</label><select id="specOps"><option>Normal</option><option>north</option><option>east</option><option>south</option><option>west</option></select></div>
          </div>

          <div class="row"><div><label>Extra Notes (optional)</label><input id="clrNotes" placeholder="e.g., depart from 2053 MRPD helipad"></div></div>
          <div class="row"><button class="btn" id="genCLR">Generate Clearance — copy</button></div>

          <div class="outwrap"><div class="gme" id="clrOut"></div><div class="plain" id="clrPlain"></div></div>
        </div>

        <!-- ================= GROUND ================= -->
        <div id="panel_gnd" class="panel">
          <div class="row">
            <div><label class="req">Callsign</label><input id="gndCall" placeholder="N123AB / AIR-1"><div class="chipsbar" id="chipsGND"></div></div>
            <div><label class="req">Airport</label><select id="gndAp"><option>LSIA</option><option>SNDY</option><option>GPSD</option><option>PBAY</option><option>RXWD</option></select></div>
            <div><label class="req">Ops Direction</label><select id="gndOps"><option>Normal</option><option>north</option><option>east</option><option>south</option><option>west</option></select></div>
          </div>
          <div class="row">
            <div><button class="btn" id="btnPushOnly">Pushback</button></div>
            <div><button class="btn" id="btnPushStart">Push & Start</button></div>
            <div><button class="btn" id="btnTaxiRwy">Progressive Taxi → Runway</button></div>
            <div><button class="btn" id="btnTaxiPark">Progressive Taxi → Parking</button></div>
          </div>
          <div class="outwrap"><div class="gme" id="gndOut"></div><div class="plain" id="gndPlain"></div></div>
        </div>

        <!-- ================= TOWER ================= -->
        <div id="panel_twr" class="panel">
          <div class="row">
            <div><label class="req">Callsign</label><input id="twrCall" placeholder="N123AB / AIR-1"><div class="chipsbar" id="chipsTWR"></div></div>
            <div><label class="req">Airport</label><select id="twrAp"><option>LSIA</option><option>SNDY</option><option>GPSD</option><option>PBAY</option><option>RXWD</option></select></div>
            <div><label class="req">Ops Direction</label><select id="twrOps"><option>Normal</option><option>north</option><option>east</option><option>south</option><option>west</option></select></div>
          </div>
          <div class="row">
            <div><button class="btn" id="btnLineUp">Line Up & Wait</button></div>
            <div><button class="btn" id="btnTakeoff">Takeoff</button></div>
            <div><button class="btn" id="btnLanding">Landing</button></div>
            <div><button class="btn" id="btnGoAround">Go Around</button></div>
          </div>
          <div class="row">
            <div><label>Noise Abatement</label><select id="twrNoise"><option>none</option><option>Left turn after clean up</option><option>Right turn after clean up</option><option>Runway heading, reduce throttle after clean up</option></select></div>
            <div><label>Action</label><select id="twrAction"><option value="hold_short">Hold short</option><option value="stop">Stop immediately</option><option value="hold_pos">Hold position</option><option value="cross">Cross runway</option><option value="luaw">Line up and wait</option></select></div>
            <div><label>Runway</label><select id="twrRunway"><option>24L</option><option>24R</option><option>06L</option><option>06R</option><option>30L</option><option>30R</option><option>12L</option><option>12R</option></select></div>
            <div style="flex:0 0 auto;align-self:flex-end"><button class="btn" id="btnTwrAction">Send Action</button></div>
          </div>
          <div class="outwrap"><div class="gme" id="twrOut"></div><div class="plain" id="twrPlain"></div></div>
        </div>

        <!-- ================= DEPARTURE / APPROACH ================= -->
        <div id="panel_dap" class="panel">
          <div class="row">
            <div><label class="req">Callsign</label><input id="dapCall" placeholder="N123AB"><div class="chipsbar" id="chipsDAP"></div></div>
            <div><label class="req">Phase</label><select id="dapPhase"><option>Departure</option><option>Approach</option></select></div>
            <div><label class="req">Airport</label><select id="dapAp"><option>LSIA</option><option>SNDY</option><option>GPSD</option><option>PBAY</option><option>RXWD</option></select></div>
          </div>
          <div class="row">
            <div><label class="req">Direction</label><select id="dapDir"><option>north</option><option>east</option><option>south</option><option>west</option></select></div>
            <div><label class="req">Altitude</label><select id="dapAlt"><option>3000</option><option>5000</option><option>7000</option><option>FL180</option><option>FL240</option></select></div>
            <div><label class="req">Heading</label><select id="dapHdg"><option>360</option><option>090</option><option>180</option><option>270</option><option>330</option><option>210</option><option>150</option><option>030</option></select></div>
          </div>
          <div class="row"><button class="btn" id="btnDAPGen">Generate — copy</button></div>
          <div class="outwrap"><div class="gme" id="dapOut"></div><div class="plain" id="dapPlain"></div></div>
        </div>

        <!-- ================= CENTER ================= -->
        <div id="panel_ctr" class="panel">
          <div class="row">
            <div><label class="req">Callsign</label><input id="ctrCall" placeholder="N123AB"><div class="chipsbar" id="chipsCTR"></div></div>
            <div><label class="req">Departure Airport</label><select id="ctrDep"><option>LSIA</option><option>SNDY</option><option>GPSD</option><option>PBAY</option><option>RXWD</option></select></div>
            <div><label class="req">Instruction</label><select id="ctrInst"><option>Climb</option><option>Descend</option><option>Heading</option><option>Direct to Fix</option><option>Handoff</option></select></div>
          </div>
          <div class="row">
            <div><label>Altitude</label><select id="ctrAlt"><option>3000</option><option>5000</option><option>7000</option><option>FL180</option><option>FL240</option></select></div>
            <div><label>Heading</label><select id="ctrHdg"><option>360</option><option>090</option><option>180</option><option>270</option><option>330</option><option>210</option><option>150</option><option>030</option></select></div>
            <div><label>Fix</label><input id="ctrFix" placeholder="coast / vine / zancudo"></div>
          </div>
          <div class="row"><button class="btn" id="btnCTRGen">Generate — copy</button></div>
          <div class="outwrap"><div class="gme" id="ctrOut"></div><div class="plain" id="ctrPlain"></div></div>
        </div>

        <!-- ================= EMERGENCIES ================= -->
        <div id="panel_emg" class="panel">
          <div class="row">
            <div><label class="req">Callsign</label><input id="emgCall" placeholder="N123AB / A320"><div class="chipsbar" id="chipsEMG"></div></div>
            <div><label class="req">Airport</label><select id="emgAp"><option>LSIA</option><option>SNDY</option><option>GPSD</option><option>PBAY</option><option>RXWD</option></select></div>
            <div><label class="req">Ops Direction</label><select id="emgOps"><option>Normal</option><option>north</option><option>east</option><option>south</option><option>west</option></select></div>
          </div>
          <div class="row">
            <div><label class="req">Event</label><select id="emgType"><option>Runway Incursion</option><option>Runway Excursion</option><option>Rejected Takeoff</option><option>Pilot Deviation</option></select></div>
            <div><label>Dispatch SAFR</label><select id="emgSAFR"><option>Dispatch</option><option>Do Not Dispatch</option></select></div>
            <div><label>Controller Callback</label><input id="emgCB" placeholder="auto from login" disabled></div>
          </div>
          <div class="row"><button class="btn warn" id="btnEMGGen">Generate GME</button><button class="btn" id="btn911Short">/911 (Short)</button><button class="btn" id="btn911Long">/911 (Long)</button></div>
          <div class="outwrap"><div class="gme" id="emgOut"></div></div>
        </div>

        <!-- ================= ADS BUILDER ================= -->
        <div id="panel_ads" class="panel">
          <div class="row">
            <div><label class="req">SAFR Status</label><select id="adSAFR"><option>Online</option><option>Offline</option></select></div>
            <div><label class="req">Training</label><select id="adTrain"><option>Not Active</option><option>Active</option></select></div>
            <div><label>Fuel Services</label><select id="adFuel"><option>Available</option><option>Limited</option><option>Unavailable</option></select></div>
          </div>
          <div class="row">
            <div style="flex:0 0 260px"><label><input type="checkbox" id="adAll" checked> All Airports Operational</label></div>
            <div style="flex:1 1 400px;display:flex;gap:10px;flex-wrap:wrap">
              <label><input type="checkbox" class="adAp" value="LSIA" checked> LSIA</label>
              <label><input type="checkbox" class="adAp" value="SNDY" checked> SNDY</label>
              <label><input type="checkbox" class="adAp" value="GPSD" checked> GPSD</label>
              <label><input type="checkbox" class="adAp" value="PBAY" checked> PBAY</label>
              <label><input type="checkbox" class="adAp" value="RXWD" checked> RXWD</label>
            </div>
          </div>
          <div class="row"><button class="btn" id="btnAdShort">Generate /ad (Short)</button><button class="btn" id="btnAdMedium">Generate /ad (Medium)</button></div>
          <div class="outwrap"><div class="gme" id="adOut"></div></div>
        </div>

        <!-- ================= HAZARD MAP (code-driven) ================= -->
        <div id="panel_haz" class="panel">
          <div class="hazLayout">
            <div class="mapWrap">
              <div class="hazTools">
                <button class="btn alt" id="btnClearHaz">Clear Hazards (view)</button>
              </div>

              <!-- Base map -->
              <img id="baseImg" src="https://www.giantbomb.com/a/uploads/scale_medium/9/93538/2570055-gta-v-map-satellite-small.jpg" alt="Map">
              <!-- SVG overlay (points & lines from code only) -->
              <svg id="hazSVG" viewBox="0 0 1200 1450" preserveAspectRatio="none"></svg>

              <!-- Category highlight panel -->
              <div class="catPanel" id="catPanel"></div>

              <!-- Legend -->
              <div class="legend" id="legend"></div>
            </div>

            <div class="hazList" id="hazList">
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                <input id="hazSearch" placeholder="Search hazards..." />
                <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="condenseList"> Condense</label>
              </div>
              <b>Hazard Notes</b> <div class="muted">Click to highlight on map.</div>
              <div id="hazItems"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
/* ================= Colors/format helpers ================= */
const COLOR_CYCLE = ['~g~','~b~','~c~','~r~','~y~']; // allowed set; no ~n~
const gmePrefix = '/gme ^* ^9 ';
function gmeColorSegments(segments){
  return gmePrefix + segments.map((s,i)=> COLOR_CYCLE[i % COLOR_CYCLE.length] + s).join(' ');
}
const q = s=>document.querySelector(s);
const qa = s=>[...document.querySelectorAll(s)];
const copy = t=>{ try{ navigator.clipboard?.writeText(t); }catch(e){} };
function callsignUpper(v){ return (v||"").toUpperCase().trim(); }
function sayRunway(rw){ return rw.replace(/\//g," and ").replace(/\d+/g,m=>m.split('').map(d=>["zero","one","two","three","four","five","six","seven","eight","nine"][+d]).join(' ')); }
function sayHeading(h){ return h.split('').map(d=>["zero","one","two","three","four","five","six","seven","eight","nine"][+d]).join(' '); }
function sayAlt(a){ const A=a.toUpperCase(); if(A.startsWith("FL")) return `flight level ${A.replace("FL","").split('').join(' ')}`; if(/^\d+$/.test(A)){const n=+A;if(n%1000===0)return `${n/1000} thousand`; if(n===3000)return"three thousand"; if(n===5000)return"five thousand"; if(n===7000)return"seven thousand"; } return a; }
function spellCS(cs){
  const map={A:"alpha",B:"bravo",C:"charlie",D:"delta",E:"echo",F:"foxtrot",G:"golf",H:"hotel",I:"india",J:"juliett",K:"kilo",L:"lima",M:"mike",N:"november",O:"oscar",P:"papa",Q:"quebec",R:"romeo",S:"sierra",T:"tango",U:"uniform",V:"victor",W:"whiskey",X:"xray",Y:"yankee",Z:"zulu"};
  const dig={0:"zero",1:"one",2:"two",3:"tree",4:"fower",5:"fife",6:"six",7:"seven",8:"eight",9:"niner"};
  return cs.toUpperCase().split('').map(ch=> map[ch]||(/\d/.test(ch)?dig[ch]:(ch==='-'?'dash':ch)) ).join(' ');
}

/* ================= Recent callsigns (chips) ================= */
function getRecent(){ try{return JSON.parse(localStorage.getItem('RECENT_CALLS')||"[]")}catch(e){return[]} }
function pushRecent(call){ const cs=callsignUpper(call); if(!cs) return; const arr=getRecent().filter(x=>x.cs!==cs); arr.unshift({cs,ts:Date.now()}); while(arr.length>16) arr.pop(); localStorage.setItem('RECENT_CALLS',JSON.stringify(arr)); }
function renderChipsFor(inputId, containerSel){
  const el=q(containerSel); if(!el) return; el.innerHTML="";
  getRecent().forEach(r=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=r.cs; s.onclick=()=>{ q('#'+inputId).value=r.cs; }; el.appendChild(s); });
}

/* ================= Login badge + controller callback ================= */
function currentController(){
  const name=(q('#loginName')?.value||'Controller').trim();
  const code=(q('#loginCode')?.value||'00000').trim();
  return {name, code, phone:`555-${String(code).padStart(5,'0').slice(-4)}`};
}
function updateLoginUI(){
  const c=currentController();
  q('#loginBadge').textContent=`${c.name} — Controller`;
  q('#emgCB').value=`${c.name} (${c.phone})`;
}
['#loginName','#loginCode'].forEach(sel=> q(sel).addEventListener('input',updateLoginUI));
updateLoginUI();

/* ================= Static data (EDITABLE) ================= */
const LETTERS = ["alpha","bravo","charlie","delta","echo","foxtrot","golf","hotel","india","juliett","kilo","lima","mike","november","oscar","papa","quebec","romeo","sierra","tango","uniform","victor","whiskey","xray","yankee","zulu"];
const AIRPORTS = ["LSIA","SNDY","GPSD","PBAY","RXWD"];
const WX_PRESETS={ CLEAR:{vis:"10",clouds:["SKC"]}, RAIN:{vis:"6",clouds:["BKN025","OVC040"]}, FOG:{vis:"2",clouds:["OVC008"]}, WINDY:{vis:"8",clouds:["SCT030"]}, OVERCAST:{vis:"8",clouds:["OVC015","BKN035"]}, STORM:{vis:"3",clouds:["BKN015","OVC030"]}, SNOW:{vis:"2",clouds:["OVC010"]} };
const WIND_PROFILES={ CALM:"000/00", LIGHT:"220/06", BREEZY:"230/12", WINDY:"250/22G30", CROSS:"090/18" };

/* Runway lookup by ops-direction */
const RUNWAYS = {
  LSIA: { normal:"24R/24L", reverse:"06" },
  SNDY: { normal:"30", reverse:"12" },
  GPSD: { normal:"11/29", reverse:"29" },
  PBAY: { normal:"01/19", reverse:"01" },
  RXWD: { normal:"08/26", reverse:"08" }
};
/* Area hazard hints (used in VFR & Special Ops) */
const HAZ_HINTS = {
  LSIA:{ north:"Caution high-rises; downtown cluster.", east:"Caution harbor cranes & oil fields.", south:"Caution coastal bridges & shipping.", west:"Caution hills & broadcast masts." },
  SNDY:{ north:"Caution Alamo Sea masts; shoreline birds.", east:"Caution power lines along Senora Fwy.", south:"Caution prison complex—do not overfly.", west:"Caution oil derricks / cement plant." },
  GPSD:{ north:"Caution foothill shear near ridges.", east:"Caution windmills west of field.", south:"Caution power lines & farms.", west:"Caution canyons and low masts." },
  PBAY:{ north:"Caution Chiliad ridge masts.", east:"Caution coastal pines.", south:"Caution forest downdrafts.", west:"Caution shoreline turbulence." },
  RXWD:{ north:"Caution valley ridgeline & towers.", east:"Caution industrial stacks.", south:"Caution city tower cluster.", west:"Caution railyard cranes." }
};
const AREA_LOCAL_HAZARDS={
  "Los Santos (city)":"Dense high-rises; port cranes; shoreline heli traffic.",
  "Sandy Shores":"Prison complex—do not overfly; Sonora power lines.",
  "Grapeseed":"Windmills west of field; farms; low masts.",
  "Paleto Bay":"Power lines near coast; Mt. Chiliad slopes; construction.",
  "Harmony / Route 68":"Industrial stacks; low towers near highway.",
  "Senora Freeway":"High-speed corridor; power spans; rotor traffic.",
  "Palomino Freeway":"Bridges and overhead cranes.",
  "Zancudo Area":"Restricted airspace; bridge masts; river spans."
};

/* SID map & squawk seeds */
const SIDMAP = {
  "LSIA → SNDY":"port one", "LSIA → PBAY":"coast two", "LSIA → GPSD":"vinewood one", "LSIA → RXWD":"east river one",
  "SNDY → LSIA":"desert one", "SNDY → PBAY":"chiliad one", "SNDY → GPSD":"senora one", "SNDY → RXWD":"route 68 one",
  "GPSD → LSIA":"farm one", "GPSD → PBAY":"ridge one", "GPSD → RXWD":"grain one",
  "PBAY → LSIA":"chiliad one", "PBAY → GPSD":"coastal ridge", "PBAY → RXWD":"forest one",
  "RXWD → LSIA":"county one", "RXWD → GPSD":"municipal one", "RXWD → SNDY":"north desert", "RXWD → PBAY":"bayline"
};
const SQUAWK_SEED = { LSIA:9010, SNDY:3037, PBAY:1080, GPSD:2058, RXWD:4401 };
function nextSquawk(dep){
  const seed=SQUAWK_SEED[dep]||3300; const key='SQUAWK_'+dep;
  let cur=parseInt(localStorage.getItem(key)||seed,10);
  cur=(cur+1)%7777;
  if(/[89]/.test(String(cur))) cur=seed;
  localStorage.setItem(key,String(cur).padStart(4,'0'));
  return String(cur).padStart(4,'0');
}
function pickRunway(airport, mode){
  const m=RUNWAYS[airport]||{}; const key=(mode||'normal').toLowerCase()==='reverse'?'reverse':'normal';
  return (m[key]||m.normal||"runway").toUpperCase();
}

/* ================= ATIS (automatic) ================= */
(function initATIS(){
  const stored = localStorage.getItem('ATIS_LETTER')||'alpha';
  q('#aLetter').value = stored;
  q('#resetATIS').onclick=()=>{ q('#aLetter').value='alpha'; localStorage.setItem('ATIS_LETTER','alpha'); };

  q('#genATIS').onclick=()=>{
    const tod=q('#aTod').value; const wx=q('#aWx').value; const windKey=q('#aWind').value; const tempFeel=q('#aTempFeel').value;
    if(!tod||!wx||!windKey){ q('#atisOut').textContent="fix: select time, weather, wind"; q('#atisPlain').textContent=""; return; }

    const letter=q('#aLetter').value||'alpha';
    const wind=WIND_PROFILES[windKey]||'000/00';
    const preset=WX_PRESETS[wx]||{vis:"10",clouds:["SKC"]};
    const zZulu = (()=>{ const d=new Date(); return String(d.getUTCHours()).padStart(2,'0')+String(d.getUTCMinutes()).padStart(2,'0')+' zulu'; })();

    const tempRanges={Cold:[-2,4],Cool:[5,9],Mild:[10,17],Warm:[18,25],Hot:[26,33]};
    const tR=tempRanges[tempFeel]||[10,17]; const temp=Math.round(tR[0]+Math.random()*(tR[1]-tR[0]));
    const dew=Math.max(-2, temp-3);

    const layers = preset.clouds.length ? preset.clouds : ["SKC"];
    const baseAlt = (2990 + Math.floor(Math.random()*30)); // 29.90–30.19
    const altMap = {}; AIRPORTS.forEach((ap,i)=>{ altMap[ap]=(baseAlt + (i%3)-1); });

    const opsMode=q('#aOpsMode').value||'Normal';
    const rwStr = AIRPORTS.map(ap=> `${ap} ${pickRunway(ap, opsMode)}`).join(', ');

    const noise = q('#aNoise').checked ? " Noise abatement in effect." : "";
    const opsSummary = q('#apAll').checked ? "All airports operational." : "Check NOTAMs for field restrictions.";

    const gmeSegments=[
      `ATIS San Andreas, Information ${letter}.`,
      `${tod.toLowerCase()} conditions ${wx.toLowerCase()}, wind ${wind.toLowerCase()}, visibility ${preset.vis}sm.`,
      `clouds ${layers.join(' ')}, temp ${temp}, dew ${dew}.`,
      `altimeter ${AIRPORTS.map(ap=>`${ap} ${String(altMap[ap]).slice(0,2)}.${String(altMap[ap]).slice(2)}`).join(', ')}.`,
      `approaches ${opsMode.toLowerCase()} in use: ${rwStr}.`,
      opsSummary + noise,
      `advise on initial contact you have information ${letter}.`
    ];
    const gme = gmeColorSegments(gmeSegments);

    const plain = [
      `San Andreas ATIS, information ${letter}, ${zZulu}.`,
      `Wind ${wind.replace('/',' at ')}.`,
      `Visibility ${preset.vis}.`,
      `Ceiling ${layers.join(', ')}.`,
      `Temperature ${temp}, dew point ${dew}.`,
      `Altimeter ${AIRPORTS.map(ap=>`${ap} ${String(altMap[ap]).slice(0,2)}.${String(altMap[ap]).slice(2)}`).join(', ')}.`,
      `Approaches ${opsMode} operations. Runways: ${rwStr}.`,
      opsSummary + noise,
      `Advise on initial contact you have information ${letter}.`
    ].join('\n');

    q('#atisOut').textContent=gme; q('#atisPlain').textContent=plain; copy(gme);

    const idx=(LETTERS.indexOf(letter)+1)%LETTERS.length;
    const next=LETTERS[idx]; localStorage.setItem('ATIS_LETTER', next); q('#aLetter').value = next;
  };
})();

/* ================= Clearance ================= */
(function initCLR(){
  const t=q('#clrType'), deptsWrap=q('#specDeptsWrap'), vfrRow=q('#VFRRow'), ifrRow=q('#IFRRow'), specRow=q('#specRow');
  function showRows(){
    const v=t.value;
    ifrRow.style.display = (v==='IFR')?'flex':'none';
    vfrRow.style.display = (v==='VFR')?'flex':'none';
    specRow.style.display = (v==='Special Ops')?'flex':'none';
    deptsWrap.style.display = (v==='Special Ops')?'block':'none';
  }
  t.addEventListener('change', showRows); showRows();
  q('#clrRoute').addEventListener('change',()=>{ q('#clrSid').value = (SIDMAP[q('#clrRoute').value]||'auto'); });
  q('#genCLR').onclick=genCLR;
})();
function genCLR(){
  const civil = q('#civilCS').checked;
  const call=callsignUpper(q('#clrCall').value); if(!call){ q('#clrOut').textContent="fix: callsign"; q('#clrPlain').textContent=""; return; }
  const type=q('#clrType').value;
  let out="", plain="";
  if(type==="IFR"){
    const r=q('#clrRoute').value; const sid=(SIDMAP[r]||'sid'); const [dep,to]=r.split('→').map(s=>s.trim());
    const squawk = nextSquawk(dep); const rw = pickRunway(dep,'normal');
    out = gmeColorSegments([`${dep} delivery clears ${call} to ${to} via ${sid}, then as filed.`,`maintain 5,000. expect FL240 ten minutes after departure.`,`squawk ${squawk}.`,`expect ${rw}.`]);
    plain = `${dep} Delivery, ${civil?call:spellCS(call)}, cleared to ${to} via ${sid}, then as filed. Maintain five thousand. Expect flight level two four zero in ten minutes. Squawk ${squawk.split('').join(' ')}. Expect runway ${sayRunway(rw)}.`;
  } else if(type==="VFR"){
    const ap=q('#VFRDep').value, dir=q('#VFRDir').value;
    const haz=(HAZ_HINTS[ap]||{})[dir]||"Caution local obstacles.";
    const squawk=nextSquawk(ap);
    out = gmeColorSegments([`${ap} delivery clears ${call} VFR for the ${dir} departure, maintain 1,500.`,`${haz}`,`squawk ${squawk}.`,`contact ground 122.3 when ready to taxi.`]);
    plain = `${ap} Delivery, ${civil?call:spellCS(call)}, cleared VFR for the ${dir} departure, maintain one thousand five hundred. ${haz} Squawk ${squawk.split('').join(' ')}. Contact ground on one two two point three when ready to taxi.`;
  } else {
    const depts=[...q('#specDepts').selectedOptions].map(o=>o.value).join(", ");
    const areas=[...q('#specAreas').selectedOptions].map(o=>o.value);
    const ops=q('#specOps').value;
    const ap=q('#specDep').value;
    const rw = pickRunway(ap, ops!=='Normal'?ops:'normal');
    const squawk = nextSquawk(ap);
    const notes=q('#clrNotes').value.trim();
    const areaHaz = areas.map(a=>AREA_LOCAL_HAZARDS[a]).filter(Boolean).join(' ');
    out = gmeColorSegments([`${ap} delivery clears ${call} (${depts||'agency'}) to operate within ${areas.join(', ')||'assigned areas'}.`,`maintain 500 agl. ${areaHaz||'Use published corridors; watch local obstacles.'}`,`squawk ${squawk}.`,`expect ${rw}.`, notes?notes:""]);
    plain = `${ap} Delivery, ${civil?call:spellCS(call)} (${depts||'agency'}), cleared to operate within ${areas.join(', ')||'assigned areas'}. Maintain five hundred AGL. ${(areaHaz||'Use published corridors; watch local obstacles.')} Squawk ${squawk.split('').join(' ')}. Expect runway ${sayRunway(rw)}. ${notes?notes:""}`;
  }
  q('#clrOut').textContent=out; q('#clrPlain').textContent=plain; copy(out); pushRecent(call); renderChipsFor('clrCall','#chipsCLR');
}

/* ================= Ground / Tower / DAP / CTR / EMG ================= */
function basicOut(selOut, selPlain, segments, plain, cs){ const out=gmeColorSegments(segments); q(selOut).textContent=out; q(selPlain).textContent=plain; copy(out); if(cs){pushRecent(cs);} }

q('#btnPushOnly').onclick=()=>{ const civ=q('#civilCS').checked, cs=callsignUpper(q('#gndCall').value), ap=q('#gndAp').value; if(!cs){q('#gndOut').textContent="fix: callsign";q('#gndPlain').textContent="";return;} basicOut('#gndOut','#gndPlain',[`${ap} ground clears ${cs} for pushback.`],`${ap} Ground, ${civ?cs:spellCS(cs)}, pushback approved.`,cs); renderChipsFor('gndCall','#chipsGND'); };
q('#btnPushStart').onclick=()=>{ const civ=q('#civilCS').checked, cs=callsignUpper(q('#gndCall').value), ap=q('#gndAp').value; if(!cs){q('#gndOut').textContent="fix: callsign";q('#gndPlain').textContent="";return;} basicOut('#gndOut','#gndPlain',[`${ap} ground clears ${cs} for push and start.`],`${ap} Ground, ${civ?cs:spellCS(cs)}, push and start approved.`,cs); renderChipsFor('gndCall','#chipsGND'); };
q('#btnTaxiRwy').onclick=()=>{ const civ=q('#civilCS').checked, cs=callsignUpper(q('#gndCall').value), ap=q('#gndAp').value, rw=pickRunway(ap,q('#gndOps').value); if(!cs){q('#gndOut').textContent="fix: callsign";q('#gndPlain').textContent="";return;} basicOut('#gndOut','#gndPlain',[`${ap} ground clears ${cs} for progressive taxi`,`to ${rw}.`,`ground will call your turns.`],`${ap} Ground, ${civ?cs:spellCS(cs)}, taxi to ${sayRunway(rw)}. Ground will call your turns.`,cs); renderChipsFor('gndCall','#chipsGND'); };
q('#btnTaxiPark').onclick=()=>{ const civ=q('#civilCS').checked, cs=callsignUpper(q('#gndCall').value), ap=q('#gndAp').value; if(!cs){q('#gndOut').textContent="fix: callsign";q('#gndPlain').textContent="";return;} basicOut('#gndOut','#gndPlain',[`${ap} ground clears ${cs} for progressive taxi`,`to parking.`,`ground will call your turns.`],`${ap} Ground, ${civ?cs:spellCS(cs)}, taxi to parking. Ground will call your turns.`,cs); renderChipsFor('gndCall','#chipsGND'); };

q('#btnLineUp').onclick=()=>{ const civ=q('#civilCS').checked, cs=callsignUpper(q('#twrCall').value); if(!cs){q('#twrOut').textContent="fix: callsign";q('#twrPlain').textContent="";return;} const ap=q('#twrAp').value, rw=pickRunway(ap,q('#twrOps').value); basicOut('#twrOut','#twrPlain',[`${ap} tower clears ${cs}`,`line up and wait ${rw}.`],`${ap} Tower, ${civ?cs:spellCS(cs)}, line up and wait ${sayRunway(rw)}.`,cs); renderChipsFor('twrCall','#chipsTWR'); };
q('#btnTakeoff').onclick=()=>{ const civ=q('#civilCS').checked, cs=callsignUpper(q('#twrCall').value); if(!cs){q('#twrOut').textContent="fix: callsign";q('#twrPlain').textContent="";return;} const ap=q('#twrAp').value, rw=pickRunway(ap,q('#twrOps').value), abt=q('#twrNoise').value; const seg=[`${ap} tower clears ${cs} for takeoff ${rw}.`]; if(abt!=='none') seg.push(`${abt}.`); seg.push(`contact departure 122.5.`); basicOut('#twrOut','#twrPlain',seg,`${ap} Tower, ${civ?cs:spellCS(cs)}, cleared for takeoff ${sayRunway(rw)}.${abt==='none'?'':(' '+abt+'.')} Contact departure on one two two point five.`,cs); renderChipsFor('twrCall','#chipsTWR'); };
q('#btnLanding').onclick=()=>{ const civ=q('#civilCS').checked, cs=callsignUpper(q('#twrCall').value); if(!cs){q('#twrOut').textContent="fix: callsign";q('#twrPlain').textContent="";return;} const ap=q('#twrAp').value, rw=pickRunway(ap,q('#twrOps').value); basicOut('#twrOut','#twrPlain',[`${ap} tower clears ${cs} to land ${rw}.`,`exit runway when able;`,`contact ground 122.3.`],`${ap} Tower, ${civ?cs:spellCS(cs)}, cleared to land ${sayRunway(rw)}. Exit runway when able; contact ground on one two two point three.`,cs); renderChipsFor('twrCall','#chipsTWR'); };
q('#btnGoAround').onclick=()=>{ const civ=q('#civilCS').checked, cs=callsignUpper(q('#twrCall').value); if(!cs){q('#twrOut').textContent="fix: callsign";q('#twrPlain').textContent="";return;} const ap=q('#twrAp').value; basicOut('#twrOut','#twrPlain',[`${ap} tower instructs ${cs} go around,`,`runway heading,`,`climb to pattern altitude.`],`${ap} Tower, ${civ?cs:spellCS(cs)}, go around, runway heading, climb to pattern altitude.`,cs); renderChipsFor('twrCall','#chipsTWR'); };
q('#btnTwrAction').onclick=()=>{ const civ=q('#civilCS').checked, cs=callsignUpper(q('#twrCall').value); if(!cs){q('#twrOut').textContent="fix: callsign";q('#twrPlain').textContent="";return;} const ap=q('#twrAp').value, rw=q('#twrRunway').value, a=q('#twrAction').value; const map={hold_short:[`${ap} tower ${cs}`,`hold short ${rw}.`],stop:[`${ap} tower ${cs}`,`stop immediately.`],hold_pos:[`${ap} tower ${cs}`,`hold position.`],cross:[`${ap} tower ${cs}`,`cross ${rw}.`],luaw:[`${ap} tower ${cs}`,`line up and wait ${rw}.`]}; const seg=map[a]||[]; const plain=seg.join(' ').replace(`${ap} tower `,`${ap} Tower, `).replace(cs, (civ?cs:spellCS(cs))+', '); basicOut('#twrOut','#twrPlain',seg,plain,cs); renderChipsFor('twrCall','#chipsTWR'); };

q('#btnDAPGen').onclick=()=>{ const civ=q('#civilCS').checked, cs=callsignUpper(q('#dapCall').value); if(!cs){q('#dapOut').textContent="fix: callsign"; q('#dapPlain').textContent=""; return;} const phase=q('#dapPhase').value, ap=q('#dapAp').value, dir=q('#dapDir').value, alt=q('#dapAlt').value, hdg=q('#dapHdg').value; if(phase==="Departure"){ basicOut('#dapOut','#dapPlain',[`${ap} departure clears ${cs}`,`climb and maintain ${alt.toUpperCase()}.`,`fly heading ${hdg}.`],`${ap} Departure, ${civ?cs:spellCS(cs)}, climb and maintain ${sayAlt(alt)}. Fly heading ${sayHeading(hdg)}.`,cs); } else { basicOut('#dapOut','#dapPlain',[`${ap} approach clears ${cs}`,`descend and maintain ${alt.toUpperCase()}.`,`proceed inbound from the ${dir} sector, then vectors.`],`${ap} Approach, ${civ?cs:spellCS(cs)}, descend and maintain ${sayAlt(alt)}. Proceed inbound from the ${dir} sector.`,cs); } renderChipsFor('dapCall','#chipsDAP'); };

q('#btnCTRGen').onclick=()=>{ const civ=q('#civilCS').checked, cs=callsignUpper(q('#ctrCall').value); if(!cs){q('#ctrOut').textContent="fix: callsign"; q('#ctrPlain').textContent=""; return;} const inst=q('#ctrInst').value, alt=q('#ctrAlt').value, hdg=q('#ctrHdg').value, fix=q('#ctrFix').value||"fix"; let seg=[], plain=""; if(inst==="Climb"){seg=[`center ${cs}`,`climb and maintain ${alt.toUpperCase()}.`];plain=`Center, ${civ?cs:spellCS(cs)}, climb and maintain ${sayAlt(alt)}.`} if(inst==="Descend"){seg=[`center ${cs}`,`descend and maintain ${alt.toUpperCase()}.`];plain=`Center, ${civ?cs:spellCS(cs)}, descend and maintain ${sayAlt(alt)}.`} if(inst==="Heading"){seg=[`center ${cs}`,`fly heading ${hdg}.`];plain=`Center, ${civ?cs:spellCS(cs)}, fly heading ${sayHeading(hdg)}.`} if(inst==="Direct to Fix"){seg=[`center ${cs}`,`proceed direct ${fix}.`];plain=`Center, ${civ?cs:spellCS(cs)}, proceed direct ${fix}.`} if(inst==="Handoff"){seg=[`center ${cs}`,`contact next sector 122.7.`];plain=`Center, ${civ?cs:spellCS(cs)}, contact next sector on one two two point seven.`} basicOut('#ctrOut','#ctrPlain',seg,plain,cs); renderChipsFor('ctrCall','#chipsCTR'); };

/* ================= Emergencies ================= */
q('#btnEMGGen').onclick=()=>{ const cs=callsignUpper(q('#emgCall').value); if(!cs){ q('#emgOut').textContent="fix: callsign"; return; } const ap=q('#emgAp').value, ev=q('#emgType').value; const ctrl=q('#emgCB').value||"controller"; const msg=gmePrefix+COLOR_CYCLE[0]+`${ap} ${ev.toLowerCase()} involving ${cs}. `+COLOR_CYCLE[1]+`controller callback ${ctrl}.`; q('#emgOut').textContent=msg; copy(msg); pushRecent(cs); renderChipsFor('emgCall','#chipsEMG'); };
q('#btn911Short').onclick=()=>{ const cs=callsignUpper(q('#emgCall').value), ap=q('#emgAp').value; const msg=`/911 aircraft ${cs} incident at ${ap}. Immediate response requested.`; q('#emgOut').textContent=msg; copy(msg); };
q('#btn911Long').onclick=()=>{ const cs=callsignUpper(q('#emgCall').value), ap=q('#emgAp').value; const msg=`/911 aircraft ${cs} incident at ${ap}. Fire/EMS to respond; staging per standard. Controller callback ${q('#emgCB').value}.`; q('#emgOut').textContent=msg; copy(msg); };

/* ================= ADS builder ================= */
(function initADS(){
  function listOperational(){
    if(q('#adAll').checked) return "all airports operational";
    const picks=[...document.querySelectorAll('.adAp:checked')].map(x=>x.value);
    return (picks.length? picks.join(", ")+" operational" : "no airports operational");
  }
  function adLine(len){
    const SAFR=q('#adSAFR').value, train=q('#adTrain').value, fuel=q('#adFuel').value;
    const ops=listOperational();
    const core = (SAFR==='Online' && train==='Not Active') ? "emergencies permitted" :
                 (SAFR==='Offline') ? "emergencies not available (SAFR offline)" :
                 "no emergencies during training";
    const seg = (len==='short')
      ? [`FAA ${ops}; fuel ${fuel.toLowerCase()}; ${core}.`]
      : [`FAA ${ops}; fuel ${fuel.toLowerCase()}; SAFR ${SAFR.toLowerCase()}; training ${train.toLowerCase()}; ${core}.`];
    return gmeColorSegments(seg);
  }
  q('#adAll').addEventListener('change',(e)=>{ const on=e.target.checked; document.querySelectorAll('.adAp').forEach(cb=>cb.disabled=on); });
  q('#btnAdShort').onclick=()=>{ const m=adLine('short'); q('#adOut').textContent=m; copy(m); };
  q('#btnAdMedium').onclick=()=>{ const m=adLine('medium'); q('#adOut').textContent=m; copy(m); };
})();

/* ================= Hazard Map (code-driven only) ================= */
/* Categories & colors */
const CATS = {
  'Fire Station': '#ef4444',
  'Hospital': '#ef4444',
  'Police Station': '#3b82f6',
  'Windfarm / Turbines': '#06b6d4',
  'Power / Wires': '#22c55e',
  'Port Cranes': '#0ea5a5',
  'Wire Endpoints': '#7c3aed',
  'Bridges / Overpasses': '#f59e0b'
};
const LEGEND_ITEMS = Object.entries(CATS).map(([label,color])=>({label,color}));

/* Default hazards (edit freely) */
const HAZARD_POINTS=[
  {x:780,y:160,label:'Grapeseed Windmills',agl:450,cat:'Windfarm / Turbines',size:5,opacity:1},
  {x:220,y:290,label:'Maze Bank Tower',agl:900,cat:'Bridges / Overpasses',size:5,opacity:1},
  {x:920,y:360,label:'Port Crane Cluster',agl:250,cat:'Port Cranes',size:5,opacity:1},
  {x:300,y:1180,label:'LS Fire HQ',agl:120,cat:'Fire Station',size:4,opacity:1},
  {x:560,y:1100,label:'Pillbox Hill Medical',agl:120,cat:'Hospital',size:3,opacity:1},
  {x:260,y:1060,label:'LSPD HQ',agl:120,cat:'Police Station',size:4,opacity:1},
  {x:112,y:1340,label:'Del Perro Bridge',agl:180,cat:'Bridges / Overpasses',size:4,opacity:1}
];
const HAZARD_LINES=[
  {x1:200,y1:900,x2:520,y2:980,label:'Powerline Span',cat:'Power / Wires',width:6,opacity:1},
  {x1:260,y1:420,x2:940,y2:420,label:'Valley Span',cat:'Power / Wires',width:3,opacity:1}
];

(function renderHaz(){
  const svg=q('#hazSVG'), list=q('#hazItems'), legend=q('#legend'), catPanel=q('#catPanel');

  legend.innerHTML = '<h4>Legend</h4>'+LEGEND_ITEMS.map(i=>`<div class="item"><span class="sw" style="background:${i.color}"></span>${i.label}</div>`).join('');
  catPanel.innerHTML = '<b>Highlight Categories</b>' + Object.entries(CATS).map(([name,color])=>`
    <label><span class="catSw" style="background:${color}"></span><input type="checkbox" class="catToggle" value="${name}"> ${name}</label>
  `).join('');

  function clearRendered(){ while(svg.firstChild) svg.removeChild(svg.firstChild); list.innerHTML=''; }

  function draw(){
    clearRendered();
    // Lines
    HAZARD_LINES.forEach((L,idx)=>{
      const g=document.createElementNS("http://www.w3.org/2000/svg","g"); g.classList.add('hazL'); g.dataset.cat=L.cat||'Power / Wires'; g.dataset.key=`L${idx}`;
      const a=document.createElementNS("http://www.w3.org/2000/svg","circle");
      const b=document.createElementNS("http://www.w3.org/2000/svg","circle");
      const ln=document.createElementNS("http://www.w3.org/2000/svg","line");
      const lbl=document.createElementNS("http://www.w3.org/2000/svg","text");
      a.setAttribute('cx',L.x1); a.setAttribute('cy',L.y1); a.setAttribute('r',4); a.setAttribute('fill',CATS['Wire Endpoints']); a.setAttribute('opacity',0.95);
      b.setAttribute('cx',L.x2); b.setAttribute('cy',L.y2); b.setAttribute('r',4); b.setAttribute('fill',CATS['Wire Endpoints']); b.setAttribute('opacity',0.95);
      ln.setAttribute('x1',L.x1); ln.setAttribute('y1',L.y1); ln.setAttribute('x2',L.x2); ln.setAttribute('y2',L.y2);
      ln.setAttribute('stroke',CATS[L.cat]||'#22c55e'); ln.setAttribute('stroke-width',L.width||3); ln.setAttribute('opacity',L.opacity??1);
      lbl.setAttribute('x',L.x2+10); lbl.setAttribute('y',L.y2); lbl.setAttribute('font-size','12'); lbl.setAttribute('fill','#cfe1ff'); lbl.textContent=L.label||'Line';
      g.append(a,ln,b,lbl); svg.appendChild(g);
      list.insertAdjacentHTML('beforeend',`<div class="hazItem" data-i="L${idx}" data-cat="${g.dataset.cat}">${L.label} <span class="muted">(${g.dataset.cat})</span></div>`);
    });
    // Points
    HAZARD_POINTS.forEach((P,idx)=>{
      const g=document.createElementNS("http://www.w3.org/2000/svg","g"); g.classList.add('hazP'); g.dataset.cat=P.cat||'Fire Station'; g.dataset.key=`P${idx}`;
      const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
      const t=document.createElementNS("http://www.w3.org/2000/svg","text");
      g.setAttribute('transform',`translate(${P.x},${P.y})`);
      c.setAttribute('r',P.size||4); c.setAttribute('fill',CATS[P.cat]||'#ef4444'); c.setAttribute('opacity',P.opacity??1);
      t.setAttribute('x',14); t.setAttribute('y',4); t.setAttribute('font-size','12'); t.setAttribute('fill','#cfe1ff'); t.textContent=`${P.label}${P.agl?` ~${P.agl} AGL`:''}`;
      g.append(c,t); svg.appendChild(g);
      list.insertAdjacentHTML('beforeend',`<div class="hazItem" data-i="P${idx}" data-cat="${g.dataset.cat}">${P.label} <span class="muted">${P.agl?`~${P.agl} AGL`:''} (${g.dataset.cat})</span></div>`);
    });
  }
  draw();

  q('#btnClearHaz').onclick=()=>{ while(svg.firstChild) svg.removeChild(svg.firstChild); q('#hazItems').innerHTML='(cleared for view)'; };

  q('#hazList').addEventListener('click',e=>{
    const cell=e.target.closest('.hazItem'); if(!cell) return;
    const key=cell.dataset.i; const node=[...q('#hazSVG').children].find(n=>n.dataset.key===key);
    if(node){ node.classList.remove('pulse'); void node.offsetWidth; node.classList.add('pulse'); node.scrollIntoView({block:'center',behavior:'smooth'}); }
  });

  q('#hazSearch').addEventListener('input',e=>{
    const s=e.target.value.toLowerCase();
    [...q('#hazItems').children].forEach(row=>{
      row.style.display = row.textContent.toLowerCase().includes(s) ? '' : 'none';
    });
  });

  q('#condenseList').addEventListener('change',e=>{
    q('#hazList').classList.toggle('compact', e.target.checked);
  });

  q('#catPanel').addEventListener('change',()=>{
    const active=[...q('#catPanel').querySelectorAll('.catToggle:checked')].map(i=>i.value);
    const all=[...q('#hazSVG').children];
    if(active.length===0){ all.forEach(g=>{ g.classList.remove('dimmed','highlight'); }); return; }
    all.forEach(g=>{
      const cat=g.dataset.cat||'';
      if(active.includes(cat)){ g.classList.remove('dimmed'); g.classList.add('highlight'); }
      else { g.classList.add('dimmed'); g.classList.remove('highlight'); }
    });
  });
})();

/* ====== Tabs ====== */
(function tabWire(){
  const root=q('#atcTabs');
  root.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      root.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      qa('#sub_console .panel').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      q('#panel_'+btn.dataset.tab).classList.add('active');
    });
  });
})();

/* ====== Chips init & clear active tab ====== */
['clr','gnd','twr','dap','ctr','emg'].forEach(id=>renderChipsFor(id+'Call','#chips'+id.toUpperCase()));
q('#clearATC').onclick=()=>{ const activePanel = qa('#sub_console .panel.active')[0]; if(!activePanel) return; [...activePanel.querySelectorAll('.gme,.plain')].forEach(el=>el.textContent=''); };
</script>
</body>
</html>
